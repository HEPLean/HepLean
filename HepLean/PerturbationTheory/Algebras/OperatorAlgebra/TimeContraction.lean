/-
Copyright (c) 2025 Joseph Tooby-Smith. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Joseph Tooby-Smith
-/
import HepLean.PerturbationTheory.Algebras.OperatorAlgebra.NormalOrder
import HepLean.PerturbationTheory.Algebras.StateAlgebra.TimeOrder
/-!

# Time contractions

We define the state algebra of a field structure to be the free algebra
generated by the states.

-/

namespace FieldStruct
variable {ğ“• : FieldStruct}
open CrAnAlgebra
noncomputable section

namespace OperatorAlgebra

variable (ğ“ : ğ“•.OperatorAlgebra)
open FieldStatistic

def timeContract (Ï† Ïˆ : ğ“•.States) : ğ“.A :=
  ğ“.crAnF (ofStateAlgebra (StateAlgebra.timeOrder (StateAlgebra.ofState Ï† * StateAlgebra.ofState Ïˆ))
  - normalOrder (ofState Ï† * ofState Ïˆ))

lemma timeContract_eq_smul (Ï† Ïˆ : ğ“•.States) : ğ“.timeContract Ï† Ïˆ =
    ğ“.crAnF (ofStateAlgebra (StateAlgebra.timeOrder
    (StateAlgebra.ofState Ï† * StateAlgebra.ofState Ïˆ))
    + (-1 : â„‚) â€¢ normalOrder (ofState Ï† * ofState Ïˆ)) := by rfl

lemma timeContract_of_timeOrderProp (Ï† Ïˆ : ğ“•.States) (h : timeOrderProp Ï† Ïˆ) :
    ğ“.timeContract Ï† Ïˆ = ğ“.crAnF (âŸ¨anPart (StateAlgebra.ofState Ï†), ofState ÏˆâŸ©â‚›ca) := by
  conv_rhs =>
    rw [ofState_eq_crPart_add_anPart]
    rw [map_add, map_add, crAnF_superCommute_anPart_anPart, superCommute_anPart_crPart]
  simp [timeContract]
  rw [StateAlgebra.timeOrder_ofState_ofState_ordered h]
  rw [normalOrder_ofState_mul_ofState]
  rw [map_mul]
  simp
  rw [ofState_eq_crPart_add_anPart, ofState_eq_crPart_add_anPart]
  simp [mul_add, smul_add, add_mul]
  abel_nf

lemma timeContract_of_not_timeOrderProp (Ï† Ïˆ : ğ“•.States) (h : Â¬ timeOrderProp Ï† Ïˆ) :
    ğ“.timeContract Ï† Ïˆ = ğ“¢(ğ“• |>â‚› Ï†, ğ“• |>â‚› Ïˆ) â€¢ ğ“.timeContract Ïˆ Ï† := by
  rw [timeContract_eq_smul]
  simp only [Int.reduceNeg, one_smul, map_add]
  rw [map_smul]
  rw [crAnF_normalOrder_ofState_ofState_swap]
  rw [StateAlgebra.timeOrder_ofState_ofState_not_ordered_eq_timeOrder h]
  rw [timeContract_eq_smul]
  simp only [FieldStatistic.instCommGroup.eq_1, map_smul, one_smul, map_add, smul_add]
  rw [smul_smul, smul_smul, mul_comm]

lemma timeContract_mem_center (Ï† Ïˆ : ğ“•.States) : ğ“.timeContract Ï† Ïˆ âˆˆ Subalgebra.center â„‚ ğ“.A := by
  by_cases h : timeOrderProp Ï† Ïˆ
  Â· rw [timeContract_of_timeOrderProp _ _ _ h]
    exact ğ“.crAnF_superCommute_anPart_ofState_mem_center _ _
  Â· rw [timeContract_of_not_timeOrderProp _ _ _ h]
    refine Subalgebra.smul_mem (Subalgebra.center â„‚ ğ“.A) ?_
      ((pairedSign (ğ“•.statesStatistic Ï†)) (ğ“•.statesStatistic Ïˆ))
    rw [timeContract_of_timeOrderProp]
    exact ğ“.crAnF_superCommute_anPart_ofState_mem_center _ _
    have h1 := IsTotal.total (r := ğ“•.timeOrderProp) Ï† Ïˆ
    simp_all

lemma timeContract_zero_of_diff_grade (Ï† Ïˆ : ğ“•.States) (h : (ğ“• |>â‚› Ï†) â‰  (ğ“• |>â‚› Ïˆ)) :
    ğ“.timeContract Ï† Ïˆ = 0 := by
  by_cases h1 : timeOrderProp Ï† Ïˆ
  Â· rw [timeContract_of_timeOrderProp _ _ _ h1]
    rw [crAnF_superCommute_anPart_ofState_diff_grade_zero]
    exact h
  Â· rw [timeContract_of_not_timeOrderProp _ _ _ h1]
    rw [timeContract_of_timeOrderProp _ _ _]
    rw [crAnF_superCommute_anPart_ofState_diff_grade_zero]
    simp
    exact h.symm
    have ht := IsTotal.total (r := ğ“•.timeOrderProp) Ï† Ïˆ
    simp_all

end OperatorAlgebra

end
end FieldStruct
