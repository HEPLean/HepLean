/-
Copyright (c) 2025 Joseph Tooby-Smith. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Joseph Tooby-Smith
-/
import HepLean.PerturbationTheory.FieldStruct.CreateAnnihilate
import HepLean.PerturbationTheory.CreateAnnihilate
/-!

# State algebra

We define the state algebra of a field structure to be the free algebra
generated by the states.

-/

namespace FieldStruct
variable {ğ“• : FieldStruct}

abbrev StateAlgebra (ğ“• : FieldStruct) : Type := FreeAlgebra â„‚ ğ“•.States

namespace StateAlgebra

open FieldStatistic

def ofState (Ï† : ğ“•.States) : StateAlgebra ğ“• :=
  FreeAlgebra.Î¹ â„‚ Ï†

def ofList (Ï†s : List ğ“•.States) : StateAlgebra ğ“• :=
  (List.map ofState Ï†s).prod

@[simp]
lemma ofList_nil : ofList ([] : List ğ“•.States) = 1 := rfl

lemma ofList_append (Ï†s Ïˆs : List ğ“•.States) :
    ofList (Ï†s ++ Ïˆs) = ofList Ï†s * ofList Ïˆs := by
  rw [ofList, List.map_append, List.prod_append]
  rfl

lemma ofList_cons (Ï† : ğ“•.States) (Ï†s : List ğ“•.States) :
    ofList (Ï† :: Ï†s) = ofState Ï† * ofList Ï†s := rfl

noncomputable def ofListBasis : Basis (List ğ“•.States) â„‚ (StateAlgebra ğ“•) where
  repr := FreeAlgebra.equivMonoidAlgebraFreeMonoid.toLinearEquiv

@[simp]
lemma ofListBasis_eq_ofList (Ï†s : List ğ“•.States) :
    ofListBasis Ï†s = ofList Ï†s := by
  simp [ofListBasis, ofList, FreeAlgebra.equivMonoidAlgebraFreeMonoid]
  erw [MonoidAlgebra.lift_apply]
  simp
  rw [@FreeMonoid.lift_apply]
  simp [List.prod]
  match Ï†s with
  | [] => rfl
  | Ï† :: Ï†s =>
    erw [List.map_cons]

/-!

## The super commutor on the state algebra.

-/


noncomputable def superCommute :
   ğ“•.StateAlgebra â†’â‚—[â„‚] ğ“•.StateAlgebra â†’â‚—[â„‚] ğ“•.StateAlgebra :=
  Basis.constr ofListBasis â„‚ fun Ï†s =>
  Basis.constr ofListBasis â„‚ fun Ï†s' =>
  ofList (Ï†s ++ Ï†s') - pairedSign (FieldStatistic.ofList ğ“•.statesStatistic Ï†s)
    (FieldStatistic.ofList ğ“•.statesStatistic Ï†s') â€¢ ofList (Ï†s' ++ Ï†s)

local notation "âŸ¨" Ï†s "," Ï†s' "âŸ©â‚›" => superCommute Ï†s Ï†s'

lemma superCommute_ofList (Ï†s Ï†s' : List ğ“•.States) : âŸ¨ofList Ï†s, ofList Ï†s'âŸ©â‚› =
    ofList (Ï†s ++ Ï†s') - pairedSign (FieldStatistic.ofList ğ“•.statesStatistic Ï†s)
    (FieldStatistic.ofList ğ“•.statesStatistic Ï†s') â€¢ ofList (Ï†s' ++ Ï†s) := by
  rw [â† ofListBasis_eq_ofList, â† ofListBasis_eq_ofList]
  simp only [superCommute, Basis.constr_basis]

end StateAlgebra

end FieldStruct
